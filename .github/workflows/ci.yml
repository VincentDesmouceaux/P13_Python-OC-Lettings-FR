# .github/workflows/ci.yml
name: CI â€“ lint, tests & Northflank build

on:
  push:            { branches: ['**'] }
  pull_request:    {}
  workflow_dispatch: {}

################################################################################
# Variables publiques (tout le reste est en secrets)
################################################################################
env:
  PY_VER: '3.12'                       # version de Python pour les tests

jobs:
################################################################################
# 1 Â· TESTS
################################################################################
  test:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4

      - uses: actions/setup-python@v5
        with:
          python-version: ${{ env.PY_VER }}

      - uses: actions/cache@v4
        with:
          path: ~/.cache/pip
          key: ${{ runner.os }}-pip-${{ hashFiles('requirements.txt') }}

      - name: Install deps, lint & tests
        run: |
          python -m pip install --upgrade pip
          pip install -r requirements.txt flake8 pytest-cov
          flake8 .
          pytest -q --cov=. --cov-fail-under=80

################################################################################
# 2 Â· TRIGGER BUILD SUR NORTHFLANK (service Combined)
################################################################################
  trigger-build:
    needs: test
    if: needs.test.result == 'success'
    runs-on: ubuntu-latest
    env:
      NF_TOKEN:        ${{ secrets.NORTHFLANK_TOKEN }}        # API token (scope : Build service)
      NF_PROJECT_ID:   ${{ secrets.NF_PROJECT_ID }}   # ID du projet (pas le slug)
      NF_OBJECT_ID:    ${{ secrets.NF_OBJECT_ID }}    # ID du service Combined
    steps:
      - name: Trigger Northflank Combined build
        run: |
          set -euo pipefail

          ENDPOINT="https://api.northflank.com/v1/projects/${NF_PROJECT_ID}/services/${NF_OBJECT_ID}/build"
          echo "ðŸ”— Endpoint  : $ENDPOINT"
          echo "ðŸš€ Projet/Service : ${NF_PROJECT_ID}/${NF_OBJECT_ID}"
          
          HTTP_CODE=$(curl -sS -o /tmp/nf_resp.json -w '%{http_code}' \
                       -X POST "$ENDPOINT" \
                       -H "X-NF-API-KEY: ${NF_TOKEN}" \
                       -H "Content-Type: application/json" \
                       -d '{"reason":"GitHub Action auto-build"}')

          echo "â†©ï¸Ž HTTP $HTTP_CODE"
          cat /tmp/nf_resp.json || true

          if [[ "$HTTP_CODE" =~ ^2[0-9]{2}$ ]]; then
            echo "âœ… Build dÃ©clenchÃ© â€” suivez-le sur https://app.northflank.com/s/${NF_OBJECT_ID}"
            echo "ðŸŒ Site (quand dÃ©ployÃ©) : https://p01--holiday-homes--c7br8w6v87r6.code.run"
          else
            echo "âŒ Northflank build failed (HTTP $HTTP_CODE)" >&2
            exit 1
          fi
